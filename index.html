<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relationship Assessment Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .markdown-content h1 { font-size: 1.5em; }
        .markdown-content h2 { font-size: 1.3em; }
        .markdown-content h3 { font-size: 1.1em; }
        .markdown-content p { margin-bottom: 0.75em; line-height: 1.6; }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        .markdown-content li { margin-bottom: 0.25em; }
        .markdown-content strong { font-weight: 600; }
        .markdown-content code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: monospace;
        }
        .spinner {
            border: 3px solid rgba(147, 51, 234, 0.1);
            border-top: 3px solid #9333ea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen py-8 px-4">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold mb-2 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                Relationship Assessment Results
            </h1>
            <p class="text-gray-600 text-base md:text-lg">
                Your comprehensive relationship analysis report
            </p>
        </div>

        <!-- Results Container -->
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 fade-in">
            <!-- Loading State -->
            <div id="loadingState" class="flex flex-col items-center justify-center py-12">
                <div class="spinner mb-4"></div>
                <p class="text-gray-600 text-base">Analyzing your relationship assessment...</p>
                <p class="text-gray-500 text-sm mt-2">Generating compatibility score, strengths, areas for growth, and personalized recommendations...</p>
            </div>

            <!-- Analysis Results -->
            <div id="analysisResults" class="hidden">
                <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">üíï Your Relationship Report</h2>
                    <div class="flex gap-3 flex-wrap">
                        <button
                            id="downloadPdfBtn"
                            class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition text-base font-medium shadow-md hover:shadow-lg"
                        >
                            üìÑ Download PDF
                        </button>
                        <button
                            id="emailReportBtn"
                            class="px-6 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg transition text-base font-medium shadow-md hover:shadow-lg"
                        >
                            üìß Email Report
                        </button>
                        <button
                            onclick="window.location.href='/'"
                            class="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition text-base font-medium"
                        >
                            New Assessment
                        </button>
                    </div>
                </div>

                <!-- Compatibility Score -->
                <div id="compatibilityScore" class="bg-gradient-to-r from-purple-100 via-pink-100 to-purple-100 rounded-lg p-6 shadow-lg border-2 border-purple-300 mb-6">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-2xl">‚≠ê</span>
                        <h3 class="text-xl font-bold text-gray-800">Compatibility Score</h3>
                    </div>
                    <div id="compatibilityContent" class="text-lg font-semibold text-purple-700"></div>
                </div>

                <!-- Assessment Report -->
                <div class="bg-white rounded-lg p-6 shadow-lg border-4 border-purple-200 mb-6">
                    <div class="flex items-center gap-2 mb-4 pb-3 border-b-2 border-gray-200">
                        <span class="text-2xl">üìä</span>
                        <h3 class="text-xl font-bold text-gray-800">Detailed Assessment</h3>
                    </div>
                    <div id="assessmentContent" class="markdown-content prose max-w-none"></div>
                </div>

                <!-- Relationship Strengths -->
                <div class="bg-white rounded-lg p-6 shadow-lg border-4 border-green-200 mb-6">
                    <div class="flex items-center gap-2 mb-4 pb-3 border-b-2 border-gray-200">
                        <span class="text-2xl">üí™</span>
                        <h3 class="text-xl font-bold text-gray-800">Relationship Strengths</h3>
                    </div>
                    <div id="strengthsContent" class="markdown-content prose max-w-none"></div>
                </div>

                <!-- Areas for Growth -->
                <div class="bg-white rounded-lg p-6 shadow-lg border-4 border-amber-200 mb-6">
                    <div class="flex items-center gap-2 mb-4 pb-3 border-b-2 border-gray-200">
                        <span class="text-2xl">üå±</span>
                        <h3 class="text-xl font-bold text-gray-800">Areas for Growth</h3>
                    </div>
                    <div id="growthContent" class="markdown-content prose max-w-none"></div>
                </div>

                <!-- Personalized Recommendations -->
                <div class="bg-white rounded-lg p-6 shadow-lg border-4 border-blue-200">
                    <div class="flex items-center gap-2 mb-4 pb-3 border-b-2 border-gray-200">
                        <span class="text-2xl">üí°</span>
                        <h3 class="text-xl font-bold text-gray-800">Personalized Recommendations</h3>
                    </div>
                    <div id="recommendationsContent" class="markdown-content prose max-w-none"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4 p-6">
            <h3 class="text-xl font-bold mb-4 text-gray-800">üìß Email Your Report</h3>
            <input
                type="email"
                id="emailInput"
                placeholder="Enter your email address"
                class="w-full px-4 py-3 text-base bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition mb-4"
            >
            <div class="flex gap-3 justify-end">
                <button
                    onclick="closeEmailModal()"
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition text-base font-medium"
                >
                    Cancel
                </button>
                <button
                    onclick="sendEmail()"
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition text-base font-medium"
                >
                    Send Email
                </button>
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');

        if (!sessionId) {
            window.location.href = '/';
        }

        // Load results
        async function loadResults() {
            try {
                const response = await fetch(`/api/get-result?session=${sessionId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load results');
                }

                const data = await response.json();
                
                // Hide loading, show results
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('analysisResults').classList.remove('hidden');

                // Parse and display content
                if (data.assessmentReport) {
                    document.getElementById('assessmentContent').innerHTML = marked.parse(data.assessmentReport);
                }
                
                if (data.strengths) {
                    document.getElementById('strengthsContent').innerHTML = marked.parse(data.strengths);
                }
                
                if (data.areasForGrowth) {
                    document.getElementById('growthContent').innerHTML = marked.parse(data.areasForGrowth);
                }
                
                if (data.recommendations) {
                    document.getElementById('recommendationsContent').innerHTML = marked.parse(data.recommendations);
                }

                // Extract compatibility score
                const scoreMatch = data.assessmentReport?.match(/compatibility score[:\s]+(\d+)\/10/i) ||
                                  data.assessmentReport?.match(/score[:\s]+(\d+)\/10/i) ||
                                  data.assessmentReport?.match(/(\d+)\/10/);
                
                if (scoreMatch) {
                    const score = scoreMatch[1];
                    document.getElementById('compatibilityContent').innerHTML = `
                        <div class="text-4xl font-bold text-purple-600">${score}/10</div>
                    `;
                } else {
                    document.getElementById('compatibilityContent').innerHTML = `
                        <div class="text-gray-600">See detailed assessment below</div>
                    `;
                }

            } catch (error) {
                console.error('Error loading results:', error);
                document.getElementById('assessmentContent').innerHTML = `
                    <div class="text-red-600 font-semibold">‚ùå Error loading results. Please try again.</div>
                `;
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('analysisResults').classList.remove('hidden');
            }
        }

        // Download PDF
        document.getElementById('downloadPdfBtn').addEventListener('click', async function() {
            const button = this;
            const originalText = button.innerHTML;

            button.innerHTML = '‚è≥ Generating PDF...';
            button.disabled = true;

            try {
                const pdfContent = document.createElement('div');
                pdfContent.style.padding = '20px';
                pdfContent.style.backgroundColor = '#ffffff';
                pdfContent.style.color = '#000000';
                pdfContent.style.fontFamily = 'Arial, sans-serif';

                const title = document.createElement('h1');
                title.style.textAlign = 'center';
                title.style.marginBottom = '20px';
                title.style.color = '#9333ea';
                title.textContent = 'Relationship Assessment Report';
                pdfContent.appendChild(title);

                const timestamp = document.createElement('p');
                timestamp.style.textAlign = 'center';
                timestamp.style.marginBottom = '30px';
                timestamp.style.fontSize = '12px';
                timestamp.style.color = '#666';
                timestamp.textContent = `Generated on ${new Date().toLocaleString()}`;
                pdfContent.appendChild(timestamp);

                // Compatibility Score
                const compatScore = document.getElementById('compatibilityContent').cloneNode(true);
                const compatSection = document.createElement('div');
                compatSection.style.marginBottom = '20px';
                compatSection.style.padding = '15px';
                compatSection.style.border = '2px solid #9333ea';
                compatSection.style.borderRadius = '8px';
                compatSection.style.backgroundColor = '#f5f3ff';
                const compatTitle = document.createElement('h2');
                compatTitle.style.marginBottom = '10px';
                compatTitle.textContent = '‚≠ê Compatibility Score';
                compatSection.appendChild(compatTitle);
                compatSection.appendChild(compatScore);
                pdfContent.appendChild(compatSection);

                // Assessment Report
                const assessment = document.getElementById('assessmentContent').cloneNode(true);
                const assessSection = document.createElement('div');
                assessSection.style.marginBottom = '20px';
                assessSection.style.padding = '15px';
                assessSection.style.border = '1px solid #ccc';
                assessSection.style.borderRadius = '8px';
                const assessTitle = document.createElement('h2');
                assessTitle.style.marginBottom = '10px';
                assessTitle.textContent = 'üìä Detailed Assessment';
                assessSection.appendChild(assessTitle);
                assessSection.appendChild(assessment);
                pdfContent.appendChild(assessSection);

                // Strengths
                const strengths = document.getElementById('strengthsContent').cloneNode(true);
                const strengthSection = document.createElement('div');
                strengthSection.style.marginBottom = '20px';
                strengthSection.style.padding = '15px';
                strengthSection.style.border = '1px solid #ccc';
                strengthSection.style.borderRadius = '8px';
                const strengthTitle = document.createElement('h2');
                strengthTitle.style.marginBottom = '10px';
                strengthTitle.textContent = 'üí™ Relationship Strengths';
                strengthSection.appendChild(strengthTitle);
                strengthSection.appendChild(strengths);
                pdfContent.appendChild(strengthSection);

                // Growth Areas
                const growth = document.getElementById('growthContent').cloneNode(true);
                const growthSection = document.createElement('div');
                growthSection.style.marginBottom = '20px';
                growthSection.style.padding = '15px';
                growthSection.style.border = '1px solid #ccc';
                growthSection.style.borderRadius = '8px';
                const growthTitle = document.createElement('h2');
                growthTitle.style.marginBottom = '10px';
                growthTitle.textContent = 'üå± Areas for Growth';
                growthSection.appendChild(growthTitle);
                growthSection.appendChild(growth);
                pdfContent.appendChild(growthSection);

                // Recommendations
                const recommendations = document.getElementById('recommendationsContent').cloneNode(true);
                const recsSection = document.createElement('div');
                recsSection.style.marginBottom = '20px';
                recsSection.style.padding = '15px';
                recsSection.style.border = '1px solid #ccc';
                recsSection.style.borderRadius = '8px';
                const recsTitle = document.createElement('h2');
                recsTitle.style.marginBottom = '10px';
                recsTitle.textContent = 'üí° Personalized Recommendations';
                recsSection.appendChild(recsTitle);
                recsSection.appendChild(recommendations);
                pdfContent.appendChild(recsSection);

                const opt = {
                    margin: 10,
                    filename: `Relationship_Assessment_${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(pdfContent).save().then(() => {
                    button.innerHTML = '‚úÖ Downloaded!';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                }).catch((error) => {
                    console.error('PDF generation error:', error);
                    button.innerHTML = '‚ùå Error';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                });

            } catch (error) {
                console.error('PDF content preparation error:', error);
                button.innerHTML = '‚ùå Error';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            }
        });

        // Email modal functions
        document.getElementById('emailReportBtn').addEventListener('click', function() {
            document.getElementById('emailModal').classList.remove('hidden');
        });

        function closeEmailModal() {
            document.getElementById('emailModal').classList.add('hidden');
            document.getElementById('emailInput').value = '';
        }

        async function sendEmail() {
            const email = document.getElementById('emailInput').value.trim();
            
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = 'Sending...';
            button.disabled = true;

            try {
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        email: email
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to send email');
                }

                button.innerHTML = '‚úÖ Sent!';
                setTimeout(() => {
                    closeEmailModal();
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Email error:', error);
                alert('Failed to send email. Please try again.');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Close modal on outside click
        document.getElementById('emailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEmailModal();
            }
        });

        // Load results on page load
        loadResults();
    </script>
</body>
</html>
